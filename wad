#!/usr/bin/env bash
#
# wad - Worktree Agent Devcontainers v2.3
# Isolated development environments using git worktrees + docker compose
#
# Configuration:
#   .wad/compose.yml  - Docker compose template (full syntax)
#   .wad/config.yml   - WAD settings (ports, services)
#   .wad/.env         - Environment variables (gitignored)
#

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'
BOLD='\033[1m'

WAD_VERSION="2.3.0"
WAD_DIR=".wad"
WAD_WORKTREES_DIR=".worktrees"
WAD_CONFIG_FILE="config.yml"
WAD_COMPOSE_TEMPLATE="compose.yml"

log_info() { echo -e "${BLUE}ℹ${NC} $1"; }
log_success() { echo -e "${GREEN}✓${NC} $1"; }
log_warn() { echo -e "${YELLOW}⚠${NC} $1"; }
log_error() { echo -e "${RED}✗${NC} $1" >&2; }
log_header() { echo -e "\n${BOLD}${CYAN}$1${NC}\n"; }

die() { log_error "$1"; exit 1; }

find_repo_root() {
    # Works for normal repos and git worktrees (where .git is a file)
    git rev-parse --show-toplevel 2>/dev/null
}

escape_sed_replacement() {
    # Escape replacement text for: sed -e "s|FROM|TO|g"
    # - escape backslash first
    # - escape '&' (means "matched text" in replacement)
    # - escape delimiter '|'
    printf '%s' "$1" | sed -e 's/\\\\/\\\\\\\\/g' -e 's/&/\\\\&/g' -e 's/|/\\\\|/g'
}


check_wad_init() {
    local repo_root
    repo_root=$(find_repo_root) || die "Not in a git repository"
    [[ -d "$repo_root/$WAD_DIR" ]] || die "WAD not initialized. Run 'wad init' first."
    [[ -f "$repo_root/$WAD_DIR/$WAD_COMPOSE_TEMPLATE" ]] || die "Missing $WAD_DIR/$WAD_COMPOSE_TEMPLATE"
    echo "$repo_root"
}

# =============================================================================
# Simple YAML helpers (only for config.yml, not compose)
# =============================================================================

yaml_get() {
    local file="$1" key="$2" default="$3"
    [[ -f "$file" ]] || { echo "$default"; return; }
    
    local value=""
    case "$key" in
        *.*)
            local section="${key%%.*}"
            local subkey="${key#*.}"
            value=$(awk -v section="$section" -v subkey="$subkey" '
                /^[a-zA-Z_]+:/ { current_section = $1; gsub(/:/, "", current_section) }
                current_section == section && $1 == subkey":" { 
                    gsub(/^[^:]+:[[:space:]]*/, ""); 
                    gsub(/[[:space:]]*#.*$/, "");
                    gsub(/^["'"'"']|["'"'"']$/, "");
                    print; exit 
                }
            ' "$file")
            ;;
        *)
            value=$(grep -E "^${key}:" "$file" 2>/dev/null | head -1 | sed "s/^${key}:[[:space:]]*//" | cut -d'#' -f1 | tr -d ' \t"'"'"'')
            ;;
    esac
    echo "${value:-$default}"
}

get_config() {
    local repo_root="$1" key="$2" default="$3"
    yaml_get "$repo_root/$WAD_DIR/$WAD_CONFIG_FILE" "$key" "$default"
}

# =============================================================================
# Port Management
# =============================================================================

get_next_env_index() {
    local repo_root="$1" max_index=-1
    local env_files
    env_files=$(ls "$repo_root/$WAD_WORKTREES_DIR"/*/.wad-env 2>/dev/null || true)
    for env_file in $env_files; do
        [[ -f "$env_file" ]] || continue
        local idx=$(grep "^WAD_ENV_INDEX=" "$env_file" 2>/dev/null | cut -d= -f2)
        [[ -n "$idx" && "$idx" -gt "$max_index" ]] && max_index="$idx"
    done
    echo $((max_index + 1))
}

generate_env_file() {
    local env_name="$1" env_index="$2" repo_root="$3"
    local config="$repo_root/$WAD_DIR/$WAD_CONFIG_FILE"
    local increment=$(get_config "$repo_root" "ports.increment" "10")
    
    cat << EOF
# WAD Environment: $env_name
WAD_ENV_NAME=$env_name
WAD_ENV_INDEX=$env_index
EOF
    
    # Calculate ports from config
    awk -v idx="$env_index" -v inc="$increment" '
        /^ports:/ { in_ports = 1; next }
        in_ports && /^[a-zA-Z]/ { exit }
        in_ports && /exposed:/ { in_exposed = 1; next }
        in_exposed && /^[[:space:]]+[A-Z_]+:/ {
            name = $1; gsub(/:/, "", name)
            base = $2; gsub(/[^0-9]/, "", base)
            if (base != "") {
                port = base + (idx * inc)
                print "WAD_PORT_" name "=" port
            }
        }
    ' "$config"
}

load_env_config() {
    local repo_root="$1" env_name="$2"
    local env_file="$repo_root/$WAD_WORKTREES_DIR/$env_name/.wad-env"
    [[ -f "$env_file" ]] && source "$env_file"
}

# =============================================================================
# Compose Generation (simple variable substitution)
# =============================================================================

generate_compose() {
    local repo_root="$1" env_name="$2" worktree_path="$3"
    local template="$repo_root/$WAD_DIR/$WAD_COMPOSE_TEMPLATE"
    
    # Load port variables
    source "$worktree_path/.wad-env"
    
    # Build sed substitution commands for all WAD_PORT_* variables
    local sed_args=()
    local repo_root_esc worktree_path_esc env_name_esc
    repo_root_esc=$(escape_sed_replacement "$repo_root")
    worktree_path_esc=$(escape_sed_replacement "$worktree_path")
    env_name_esc=$(escape_sed_replacement "$env_name")

    sed_args+=(-e "s|\\\${repo_root}|${repo_root_esc}|g")
    sed_args+=(-e "s|\\\${worktree_path}|${worktree_path_esc}|g")
    sed_args+=(-e "s|\\\${env_name}|${env_name_esc}|g")
    
    # Add all WAD_PORT_* variables
    while IFS='=' read -r key value; do
        [[ "$key" == WAD_PORT_* ]] && sed_args+=(-e "s|\\\${${key}}|$(escape_sed_replacement "$value")|g")
    done < "$worktree_path/.wad-env"
    
    # Expand ~ to $HOME for paths like ~/Downloads
    sed_args+=(-e "s|~/|${HOME}/|g")
    
    # Add header and process template
    echo "# Generated by wad v${WAD_VERSION} for environment: ${env_name}"
    sed "${sed_args[@]}" "$template"
}

# =============================================================================
# Commands
# =============================================================================

cmd_init() {
    local repo_root
    repo_root=$(find_repo_root) || die "Not in a git repository"
    
    if [[ -d "$repo_root/$WAD_DIR" ]]; then
        log_warn "WAD already initialized"
        return 0
    fi
    
    log_header "Initializing WAD"
    
    mkdir -p "$repo_root/$WAD_DIR"
    mkdir -p "$repo_root/$WAD_WORKTREES_DIR"
    
    # .gitignore for secrets
    cat > "$repo_root/$WAD_DIR/.gitignore" << 'EOF'
.env
EOF
    
    # Empty env file
    cat > "$repo_root/$WAD_DIR/.env" << 'EOF'
# WAD Environment Variables (gitignored - safe for secrets)
# Sourced by: wad run, wad attach
# Also available in devcontainer at /workspace/.wad/.env
EOF
    
    # Minimal config
    cat > "$repo_root/$WAD_DIR/$WAD_CONFIG_FILE" << 'EOF'
# WAD Configuration
# Docker compose template: .wad/compose.yml
# Environment variables:   .wad/.env (gitignored)

version: 2

ports:
  increment: 10
  exposed:
    APP: 8080

# Services started with `wad run` (inside devcontainer)
services:
  app:
    name: app
    workdir: /workspace
    command: echo "Configure your app command"
    log: /tmp/app.log

EOF
    
    # Sample compose template
    cat > "$repo_root/$WAD_DIR/$WAD_COMPOSE_TEMPLATE" << 'EOF'
# WAD Docker Compose Template
# Variables: ${repo_root}, ${worktree_path}, ${env_name}, ${WAD_PORT_*}
#
# This is a standard docker-compose file with variable substitution.

services:
  devcontainer:
    image: python:3.12-slim
    working_dir: /workspace
    volumes:
      - ${worktree_path}:/workspace
      - ${repo_root}/.wad/.env:/workspace/.wad/.env:ro
    ports:
      - "${WAD_PORT_APP}:8080"
    stdin_open: true
    tty: true
    command: >
      bash -c "
        echo '[wad] Ready.'
        exec sleep infinity
      "

networks:
  default:
    name: wad-${env_name}
EOF
    
    log_success "Initialized WAD in $repo_root"
    log_info "Edit $WAD_DIR/$WAD_COMPOSE_TEMPLATE to configure your environment"
    log_info "Edit $WAD_DIR/$WAD_CONFIG_FILE for ports and services"
}

cmd_new() {
    local env_name="$1" base_branch="${2:-}"
    [[ -z "$env_name" ]] && die "Usage: wad new <name> [base-branch]"
    
    local repo_root=$(check_wad_init)
    local worktree_path="$repo_root/$WAD_WORKTREES_DIR/$env_name"
    
    [[ -d "$worktree_path" ]] && die "Environment '$env_name' already exists"
    
    log_header "Creating environment: $env_name"
    
    # Base branch selection precedence:
    # 1) explicit CLI arg
    # 2) config: worktrees.default_base
    # 3) current branch
    # 4) main/master if present
    # 5) HEAD
    if [[ -z "$base_branch" ]]; then
        base_branch=$(get_config "$repo_root" "worktrees.default_base" "")
        [[ -z "$base_branch" ]] && base_branch=$(git -C "$repo_root" symbolic-ref --quiet --short HEAD 2>/dev/null || true)

        if [[ -z "$base_branch" ]]; then
            if git -C "$repo_root" show-ref --verify --quiet refs/heads/main; then
                base_branch="main"
            elif git -C "$repo_root" show-ref --verify --quiet refs/heads/master; then
                base_branch="master"
            else
                base_branch="HEAD"
            fi
        fi
    fi
    
    local env_index=$(get_next_env_index "$repo_root")
    
    log_info "Creating git worktree..."
    git -C "$repo_root" worktree add -b "wad/$env_name" "$worktree_path" "$base_branch"
    
    log_info "Generating environment config..."
    generate_env_file "$env_name" "$env_index" "$repo_root" > "$worktree_path/.wad-env"
    
    log_info "Generating docker-compose..."
    generate_compose "$repo_root" "$env_name" "$worktree_path" > "$worktree_path/.wad-compose.yml"
    
    # Load env for port display
    source "$worktree_path/.wad-env"
    
    log_info "Starting containers..."
    docker compose -f "$worktree_path/.wad-compose.yml" -p "wad-$env_name" up -d
    
    log_info "Waiting for devcontainer..."
    local max_wait=120 waited=0
    while [[ $waited -lt $max_wait ]]; do
        if docker compose -f "$worktree_path/.wad-compose.yml" -p "wad-$env_name" exec -T devcontainer true 2>/dev/null; then
            break
        fi
        sleep 2
        waited=$((waited + 2))
        echo -n "."
    done
    echo ""
    
    [[ $waited -ge $max_wait ]] && log_warn "Devcontainer may not be fully ready"
    
    log_success "Environment '$env_name' created"
    log_info "Ports:"
    (grep "^WAD_PORT_" "$worktree_path/.wad-env" 2>/dev/null || echo "(none)") | sed "s/^/  /"
    log_info "Commands:"
    echo "  wad shell $env_name   # Enter container"
    echo "  wad run $env_name     # Start services"
    echo "  wad attach $env_name  # Start goose"
}

cmd_ls() {
    local repo_root=$(check_wad_init)
    
    echo -e "${BOLD}WAD Environments${NC}"
    echo ""
    
    local found=0
    for env_dir in "$repo_root/$WAD_WORKTREES_DIR"/*/; do
        [[ -d "$env_dir" ]] || continue
        found=1
        
        local env_name=$(basename "$env_dir")
        local env_file="$env_dir/.wad-env"
        local compose_file="$env_dir/.wad-compose.yml"
        
        local ports=""
        if [[ -f "$env_file" ]]; then
            ports=$(grep '^WAD_PORT_' "$env_file" 2>/dev/null | sed 's/^WAD_PORT_//' | tr '\n' ' ' | sed 's/[[:space:]]*$//')
        fi
        
        local status="stopped"
        if [[ -f "$compose_file" ]]; then
            local running=$(docker compose -f "$compose_file" -p "wad-$env_name" ps -q 2>/dev/null | wc -l)
            [[ "$running" -gt 0 ]] && status="${GREEN}running${NC}"
        fi
        
        local branch=$(git -C "$env_dir" branch --show-current 2>/dev/null || echo "?")
        
        printf "  ${BOLD}%-20s${NC} %s  (%s)\n" "$env_name" "${ports:+ports:$ports }$status" "$branch"
    done
    
    [[ $found -eq 0 ]] && echo "  No environments found. Create one with: wad new <name>"
}

cmd_shell() {
    local env_name="$1"
    [[ -z "$env_name" ]] && die "Usage: wad shell <name>"
    
    local repo_root=$(check_wad_init)
    local worktree_path="$repo_root/$WAD_WORKTREES_DIR/$env_name"
    [[ -d "$worktree_path" ]] || die "Not found: $env_name"
    
    docker compose -f "$worktree_path/.wad-compose.yml" -p "wad-$env_name" exec devcontainer bash
}

cmd_run() {
    local env_name="$1"
    [[ -z "$env_name" ]] && die "Usage: wad run <name>"
    
    local repo_root=$(check_wad_init)
    local worktree_path="$repo_root/$WAD_WORKTREES_DIR/$env_name"
    [[ -d "$worktree_path" ]] || die "Not found: $env_name"
    
    local config="$repo_root/$WAD_DIR/$WAD_CONFIG_FILE"
    
    # Build command to source env and start services
    local cmd="cd /workspace && "
    cmd+="[[ -f .wad/.env ]] && set -a && source .wad/.env && set +a; "
    
    # Parse services from config
    local services=$(awk '
        /^services:/ { in_svc = 1; next }
        in_svc && /^[a-zA-Z]/ && !/^[[:space:]]/ { exit }
        in_svc && /^[[:space:]]{2}[a-zA-Z_-]+:/ {
            name = $1; gsub(/:/, "", name)
            print name
        }
    ' "$config")
    
    for svc in $services; do
        local svc_workdir=$(awk -v svc="$svc" '
            /^services:/ { in_svc = 1; next }
            in_svc && /^[[:space:]]{2}[a-zA-Z_-]+:/ { 
                current = $1; gsub(/:/, "", current)
                in_current = (current == svc)
            }
            in_current && /workdir:/ { 
                gsub(/.*workdir:[[:space:]]*/, ""); 
                gsub(/[[:space:]]*$/, "");
                print; exit 
            }
        ' "$config")
        
        local svc_cmd=$(awk -v svc="$svc" '
            /^services:/ { in_svc = 1; next }
            in_svc && /^[[:space:]]{2}[a-zA-Z_-]+:/ { 
                current = $1; gsub(/:/, "", current)
                in_current = (current == svc)
            }
            in_current && /command:/ { 
                gsub(/.*command:[[:space:]]*/, ""); 
                gsub(/[[:space:]]*$/, "");
                print; exit 
            }
        ' "$config")
        
        local svc_log=$(awk -v svc="$svc" '
            /^services:/ { in_svc = 1; next }
            in_svc && /^[[:space:]]{2}[a-zA-Z_-]+:/ { 
                current = $1; gsub(/:/, "", current)
                in_current = (current == svc)
            }
            in_current && /log:/ { 
                gsub(/.*log:[[:space:]]*/, ""); 
                gsub(/[[:space:]]*$/, "");
                print; exit 
            }
        ' "$config")
        
        local svc_env=$(awk -v svc="$svc" '
            /^services:/ { in_svc = 1; next }
            in_svc && /^[[:space:]]{2}[a-zA-Z_-]+:/ { 
                current = $1; gsub(/:/, "", current)
                in_current = (current == svc)
                in_env = 0
            }
            in_current && /^[[:space:]]{4}env:/ { in_env = 1; next }
            in_current && in_env && /^[[:space:]]{6}[A-Z_]+:/ {
                key = $1; gsub(/:/, "", key)
                val = $0; gsub(/.*:[[:space:]]*/, "", val)
                gsub(/^["'"'"']|["'"'"']$/, "", val)
                print "export " key "=\"" val "\"; "
            }
            in_current && in_env && /^[[:space:]]{4}[a-z]/ { in_env = 0 }
        ' "$config")
        
        if [[ -n "$svc_cmd" ]]; then
            log_info "Starting $svc..."
            local log_redirect=""
            [[ -n "$svc_log" ]] && log_redirect=" >> $svc_log 2>&1"
            cmd+="$svc_env cd ${svc_workdir:-/workspace} && $svc_cmd$log_redirect & "
        fi
    done
    
    cmd+="echo 'Services started'; sleep infinity"
    
    docker compose -f "$worktree_path/.wad-compose.yml" -p "wad-$env_name" exec -d devcontainer bash -c "$cmd"
    
    log_success "Services started"
    log_info "View logs: wad logs $env_name <service>"
}

cmd_attach() {
    local env_name="$1"
    [[ -z "$env_name" ]] && die "Usage: wad attach <name>"
    
    local repo_root=$(check_wad_init)
    local worktree_path="$repo_root/$WAD_WORKTREES_DIR/$env_name"
    [[ -d "$worktree_path" ]] || die "Not found: $env_name"
    
    local cmd=""
    cmd+="[[ -f /workspace/.wad/.env ]] && set -a && source /workspace/.wad/.env && set +a; "
    
    cmd+="cd /workspace && exec goose"
    
    docker compose -f "$worktree_path/.wad-compose.yml" -p "wad-$env_name" exec devcontainer bash -c "$cmd"
}

cmd_logs() {
    local env_name="$1" service="${2:-}"
    [[ -z "$env_name" ]] && die "Usage: wad logs <name> [service]"
    
    local repo_root=$(check_wad_init)
    local worktree_path="$repo_root/$WAD_WORKTREES_DIR/$env_name"
    [[ -d "$worktree_path" ]] || die "Not found: $env_name"
    
    if [[ -z "$service" ]]; then
        docker compose -f "$worktree_path/.wad-compose.yml" -p "wad-$env_name" logs -f
    else
        local config="$repo_root/$WAD_DIR/$WAD_CONFIG_FILE"
        local log_file=$(awk -v svc="$service" '
            /^services:/ { in_svc = 1; next }
            in_svc && /^[[:space:]]{2}[a-zA-Z_-]+:/ { 
                current = $1; gsub(/:/, "", current)
                in_current = (current == svc)
            }
            in_current && /log:/ { 
                gsub(/.*log:[[:space:]]*/, ""); 
                gsub(/[[:space:]]*$/, "");
                print; exit 
            }
        ' "$config")
        
        if [[ -n "$log_file" ]]; then
            docker compose -f "$worktree_path/.wad-compose.yml" -p "wad-$env_name" exec devcontainer tail -f "$log_file"
        else
            die "Unknown service: $service"
        fi
    fi
}

cmd_start() {
    local env_name="$1"
    [[ -z "$env_name" ]] && die "Usage: wad start <name>"
    
    local repo_root=$(check_wad_init)
    local worktree_path="$repo_root/$WAD_WORKTREES_DIR/$env_name"
    [[ -d "$worktree_path" ]] || die "Not found: $env_name"
    
    load_env_config "$repo_root" "$env_name"
    docker compose -f "$worktree_path/.wad-compose.yml" -p "wad-$env_name" up -d
    log_success "Started"
}

cmd_stop() {
    local env_name="$1"
    [[ -z "$env_name" ]] && die "Usage: wad stop <name>"
    
    local repo_root=$(check_wad_init)
    local worktree_path="$repo_root/$WAD_WORKTREES_DIR/$env_name"
    [[ -d "$worktree_path" ]] || die "Not found: $env_name"
    
    docker compose -f "$worktree_path/.wad-compose.yml" -p "wad-$env_name" stop
    log_success "Stopped"
}

cmd_rm() {
    local env_name="$1" force="${2:-}"
    [[ -z "$env_name" ]] && die "Usage: wad rm <name> [--force]"
    
    local repo_root=$(check_wad_init)
    local worktree_path="$repo_root/$WAD_WORKTREES_DIR/$env_name"
    [[ -d "$worktree_path" ]] || die "Not found: $env_name"
    
    if [[ "$force" != "--force" ]]; then
        read -p "Remove '$env_name'? [y/N] " -n 1 -r; echo
        [[ $REPLY =~ ^[Yy]$ ]] || exit 0
    fi
    
    log_info "Removing containers..."
    docker compose -f "$worktree_path/.wad-compose.yml" -p "wad-$env_name" down -v 2>/dev/null || true

    log_info "Removing worktree..."
    if ! git -C "$repo_root" worktree remove "$worktree_path" --force 2>/dev/null; then
        log_warn "Worktree removal failed; deleting uid=0 (root-owned) paths and retrying..."
        # Some containers create files as uid 0 on bind-mounted volumes.
        # That can prevent deletion on the host. Remove only uid-0 paths.
        docker run --rm -v "$worktree_path:/workspace" alpine:3.19 sh -c '
          set -e
          find /workspace -mindepth 1 -uid 0 -exec rm -rf -- {} + 2>/dev/null || true
        ' || true

        git -C "$repo_root" worktree remove "$worktree_path" --force 2>/dev/null || rm -rf "$worktree_path"
    fi

    git -C "$repo_root" branch -D "wad/$env_name" 2>/dev/null || true
    
    log_success "Removed"
}

cmd_help() {
    cat << EOF
${BOLD}wad${NC} v$WAD_VERSION - Worktree Agent Devcontainers

${BOLD}COMMANDS${NC}
  init              Initialize wad in current repo
  new <name>        Create new environment
  ls                List environments
  
  start <name>      Start containers
  stop <name>       Stop containers  
  rm <name>         Remove environment
  
  shell <name>      Enter container shell
  run <name>        Start services (from config.yml)
  attach <name>     Start goose session
  logs <name> [svc] View logs

${BOLD}CONFIGURATION${NC}
  .wad/compose.yml      Docker compose template (full syntax)
  .wad/config.yml       WAD settings (ports, services)
  .wad/.env             Environment variables (gitignored)

${BOLD}TEMPLATE VARIABLES${NC}
  \${repo_root}         Path to main repository
  \${worktree_path}     Path to worktree directory  
  \${env_name}          Environment name
  \${WAD_PORT_*}        Calculated ports from config.yml

${BOLD}EXAMPLE${NC}
  wad init
  # Edit .wad/compose.yml (your docker-compose template)
  # Edit .wad/config.yml (ports, services)
  wad new feature-x
  wad run feature-x
  wad attach feature-x
EOF
}

# Main
case "${1:-help}" in
    init)    cmd_init "${@:2}" ;;
    new)     cmd_new "${@:2}" ;;
    ls)      cmd_ls ;;
    start)   cmd_start "${@:2}" ;;
    stop)    cmd_stop "${@:2}" ;;
    rm)      cmd_rm "${@:2}" ;;
    shell)   cmd_shell "${@:2}" ;;
    run)     cmd_run "${@:2}" ;;
    attach)  cmd_attach "${@:2}" ;;
    logs)    cmd_logs "${@:2}" ;;
    help|--help|-h) cmd_help ;;
    version|--version|-v) echo "wad $WAD_VERSION" ;;
    *)       die "Unknown: $1" ;;
esac
